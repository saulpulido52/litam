<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Calendar Frontend - Litam</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: #f9fafb;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 500;
            margin: 5px 0;
        }
        .status.loading {
            background: #fef3c7;
            color: #92400e;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .appointment-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #2563eb;
        }
        .appointment-today {
            border-left-color: #dc2626;
            background: #fef2f2;
        }
        .appointment-scheduled {
            border-left-color: #059669;
        }
        .appointment-cancelled {
            border-left-color: #f59e0b;
            opacity: 0.7;
        }
        pre {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Calendar Frontend - Litam</h1>
        <p>Esta p√°gina verifica la conectividad entre el frontend y la API de citas del backend.</p>

        <div class="test-section">
            <h3>üì° Estado de Conectividad</h3>
            <div id="connectivity-status" class="status loading">Verificando conexi√≥n...</div>
            <button onclick="testConnectivity()">Probar Conexi√≥n</button>
        </div>

        <div class="test-section">
            <h3>ü©∫ Test Usuario de Prueba</h3>
            <div id="auth-status" class="status loading">Verificando autenticaci√≥n...</div>
            <div>
                <label>Email: </label>
                <input type="email" id="test-email" value="nutriologo@test.com" style="padding: 5px; margin: 5px;">
                <label>Password: </label>
                <input type="password" id="test-password" value="password123" style="padding: 5px; margin: 5px;">
                <button onclick="testLogin()">Hacer Login de Prueba</button>
            </div>
        </div>

        <div class="test-section">
            <h3>üìÖ Test API de Citas</h3>
            <div id="appointments-status" class="status loading">Listo para probar...</div>
            <button onclick="testAppointmentsAPI()" id="test-appointments-btn">Obtener Citas</button>
            <div id="appointments-count"></div>
            <div id="appointments-today"></div>
        </div>

        <div class="test-section">
            <h3>üìã Datos de Citas (Raw)</h3>
            <pre id="raw-data">Los datos aparecer√°n aqu√≠ despu√©s de hacer la prueba...</pre>
        </div>

        <div class="test-section">
            <h3>üîÑ Citas Transformadas (Para Calendario)</h3>
            <div id="transformed-appointments"></div>
        </div>

        <div class="test-section">
            <h3>üî• Citas de Hoy</h3>
            <div id="today-appointments">Las citas de hoy aparecer√°n aqu√≠...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000/api';
        let authToken = null;

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message;
        }

        async function testConnectivity() {
            updateStatus('connectivity-status', 'loading', 'Probando conexi√≥n...');
            
            try {
                const response = await fetch(`${API_BASE}/auth/health-check`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    updateStatus('connectivity-status', 'success', '‚úÖ Conexi√≥n exitosa al backend');
                } else {
                    updateStatus('connectivity-status', 'error', `‚ùå Error de conexi√≥n: ${response.status}`);
                }
            } catch (error) {
                updateStatus('connectivity-status', 'error', `‚ùå Error de conexi√≥n: ${error.message}`);
            }
        }

        async function testLogin() {
            updateStatus('auth-status', 'loading', 'Intentando login...');
            
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    authToken = data.data.access_token;
                    updateStatus('auth-status', 'success', `‚úÖ Login exitoso como: ${data.data.user.first_name} ${data.data.user.last_name} (${data.data.user.role.name})`);
                    document.getElementById('test-appointments-btn').disabled = false;
                } else {
                    updateStatus('auth-status', 'error', `‚ùå Error de login: ${data.message || 'Error desconocido'}`);
                }
            } catch (error) {
                updateStatus('auth-status', 'error', `‚ùå Error de conexi√≥n: ${error.message}`);
            }
        }

        async function testAppointmentsAPI() {
            if (!authToken) {
                updateStatus('appointments-status', 'error', '‚ùå Debes hacer login primero');
                return;
            }

            updateStatus('appointments-status', 'loading', 'Obteniendo citas del API...');

            try {
                const response = await fetch(`${API_BASE}/appointments/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    const appointments = data.data;
                    updateStatus('appointments-status', 'success', `‚úÖ API funcionando correctamente`);
                    
                    // Mostrar resumen
                    document.getElementById('appointments-count').innerHTML = `
                        <strong>üìä Total de citas: ${appointments.length}</strong>
                    `;

                    // Mostrar datos raw
                    document.getElementById('raw-data').textContent = JSON.stringify(appointments, null, 2);

                    // Transformar datos para el calendario
                    const transformedEvents = transformAppointmentsToEvents(appointments);
                    displayTransformedAppointments(transformedEvents);

                    // Mostrar citas de hoy
                    const today = new Date().toISOString().split('T')[0];
                    const todayEvents = transformedEvents.filter(event => event.date === today);
                    displayTodayAppointments(todayEvents);

                } else {
                    updateStatus('appointments-status', 'error', `‚ùå Error del API: ${data.message || 'Error desconocido'}`);
                }
            } catch (error) {
                updateStatus('appointments-status', 'error', `‚ùå Error de conexi√≥n: ${error.message}`);
            }
        }

        function transformAppointmentsToEvents(appointments) {
            return appointments.map(apt => {
                const startDate = new Date(apt.start_time);
                const endDate = new Date(apt.end_time);
                
                return {
                    id: apt.id,
                    title: apt.notes || 'Consulta',
                    patient_name: apt.patient ? `${apt.patient.first_name} ${apt.patient.last_name}` : 'Paciente desconocido',
                    patient_email: apt.patient?.email || '',
                    date: startDate.toISOString().split('T')[0],
                    start_time: startDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    end_time: endDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    type: 'consultation',
                    location: apt.meeting_link ? 'virtual' : 'presencial',
                    status: apt.status,
                    notes: apt.notes,
                    original: apt
                };
            });
        }

        function displayTransformedAppointments(events) {
            const container = document.getElementById('transformed-appointments');
            
            if (events.length === 0) {
                container.innerHTML = '<p>No hay citas transformadas.</p>';
                return;
            }

            // Agrupar por fecha
            const eventsByDate = {};
            events.forEach(event => {
                if (!eventsByDate[event.date]) {
                    eventsByDate[event.date] = [];
                }
                eventsByDate[event.date].push(event);
            });

            let html = '<h4>üìÖ Citas Agrupadas por Fecha:</h4>';
            Object.entries(eventsByDate).forEach(([date, dayEvents]) => {
                const dateObj = new Date(date);
                const isToday = date === new Date().toISOString().split('T')[0];
                
                html += `
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px; ${isToday ? 'border: 2px solid #dc2626;' : ''}">
                        <h5>${dateObj.toLocaleDateString('es-ES', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}${isToday ? ' (HOY)' : ''} - ${dayEvents.length} cita${dayEvents.length !== 1 ? 's' : ''}</h5>
                `;
                
                dayEvents.forEach(event => {
                    html += `
                        <div class="appointment-item ${isToday ? 'appointment-today' : ''} ${event.status === 'scheduled' ? 'appointment-scheduled' : ''} ${event.status.includes('cancelled') ? 'appointment-cancelled' : ''}">
                            <strong>${event.start_time}</strong> - ${event.patient_name}
                            <br><small>Estado: ${event.status} | Tipo: ${event.location} | Notas: ${event.notes || 'Sin notas'}</small>
                        </div>
                    `;
                });
                
                html += '</div>';
            });

            container.innerHTML = html;
        }

        function displayTodayAppointments(todayEvents) {
            const container = document.getElementById('today-appointments');
            
            if (todayEvents.length === 0) {
                container.innerHTML = '<p style="color: #ef4444; font-weight: 500;">‚ùå No hay citas para hoy en los datos del API</p>';
                return;
            }

            let html = `<h4 style="color: #dc2626;">üî• ${todayEvents.length} cita${todayEvents.length !== 1 ? 's' : ''} para hoy:</h4>`;
            
            todayEvents.forEach(event => {
                html += `
                    <div class="appointment-item appointment-today">
                        <strong>‚è∞ ${event.start_time} - ${event.end_time}</strong>
                        <br>üë§ <strong>${event.patient_name}</strong>
                        <br>üìã Estado: <span style="font-weight: 500;">${event.status}</span>
                        <br>üìù Notas: ${event.notes || 'Sin notas'}
                        <br>üîó Tipo: ${event.location}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Auto-inicializar pruebas
        window.onload = function() {
            console.log('üöÄ Iniciando tests autom√°ticos...');
            testConnectivity();
        };
    </script>
</body>
</html> 